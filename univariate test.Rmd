Chapter 2: testing a hypothesis with an univariate test. 

To perform the Chi-squared test, a contingency_table needs to be constructed between the column 'most_abundant_phylum2' and the column 'Study.Group', both part of the dataframe 'most_abundant'

```{r}
contingency_table <- table(most_abundant$Most_abundant_phylum2, most_abundant$Study.Group)

print(contingency_table)
```

One of the conditions of the Chi-square test of independence is that the expected frequency in each cell of the contingency table should be at least 5. This was calculated by using the contingency_table generated above.  

```{r}
row_totals <- rowSums(contingency_table)
col_totals <- colSums(contingency_table)
grand_total <- sum(contingency_table)

expected <- outer(row_totals, col_totals) / grand_total

print(expected)
```

To make the meaning of these values more clear, a dataframe containting the observed and expected frequencies was created.

```{r}
observed_df <- as.data.frame(as.table(contingency_table))
expected_df <- as.data.frame(as.table(expected))

df_observed_expected <- data.frame(
  most_abundant_phylum = observed_df$Var1,
  disease_status = observed_df$Var2,
  observed = observed_df$Freq,
  expected = expected_df$Freq
)

print(df_observed_expected)
```

There are no values smaller than 5 in the column 'expected', so the Chi-square test can be performed. 

```{r}
chi_square_result <- chisq.test(contingency_table)
chi_square_result
```

To visualize the chi-square test, a bar chart was constructed. 

```{r}
library(ggplot2)
ggplot(df_observed_expected, aes(x = interaction(most_abundant_phylum, disease_status), fill = disease_status)) +
  geom_bar(aes(y = observed), stat = "identity", position = "dodge", color = "black") +
  geom_point(aes(y = expected), position = position_dodge(width = 0.5), color = "yellow", size = 1.8) +
  labs(title = "Observed (bars) vs expected (dots) frequencies",
       x = "Most abundant phylum",
       y = "Frequency",
       fill = "Disease status") +
  theme_dark() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```